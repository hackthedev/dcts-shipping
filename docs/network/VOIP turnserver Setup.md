# Turn Server Manual

## Mandatory fields in your app config

```json
{
  "serverinfo": {
    "app": {
      "url": "https://app.example.com:2087"
    },
    "ssl": {
      "enabled": 1,
      "key":  "/etc/letsencrypt/live/app.example.com/privkey.pem",
      "cert": "/etc/letsencrypt/live/app.example.com/fullchain.pem",
      "chain": "/etc/letsencrypt/live/app.example.com/chain.pem"
    },
    "turn": {
      "enabled": true,
      "host": "turn.example.com",
      "port": 3478,
      "secret": "YOUR_SHARED_TURN_SECRET"
    }
  }
}
```

### what each field means (and must match)

- `serverinfo.app.url`

  - Public HTTPS origin of your web app, e.g. `https://app.example.com:2087`.
  - Must use **HTTPS** (browsers require secure context for mic/cam + `turns:`).
  - TLS certs in `ssl.*` must belong to **`app.example.com`**.

- `serverinfo.ssl.*`

  - Paths to your **web app’s** TLS certs.

  - Use Let’s Encrypt **`fullchain.pem`** + `privkey.pem`.

    > [!CAUTION]
    >
    > SSL / TLS **is required** for your turn server to work!

- `serverinfo.turn.host`

  - DNS name of your TURN box, e.g. **`turn.example.com`**.
  - This **must resolve directly** to your TURN server’s public IP.
  - If you use Cloudflare for DNS, set this record to **DNS only (grey cloud)**.

- `serverinfo.turn.port`

  - Client TURN port (default **3478** for UDP/TCP). If you use a custom port, put it here and open it in the firewall.

- `serverinfo.turn.secret`

  - The **exact same string** as Coturn’s `static-auth-secret` (REST auth).

  - Example in `/etc/turnserver.conf`:

    ```bash
    use-auth-secret
    static-auth-secret=YOUR_SHARED_TURN_SECRET
    realm=example.com
    ```

  - Keep this secret out of source control.

> that’s all the app needs. your `/ice` endpoint will read these three values to mint temporary TURN creds that browsers use.

------

## What must match on the TURN side (for reference)

In **Coturn** (`/etc/turnserver.conf`) make sure:

```bash
listening-port=3478
tls-listening-port=5349
external-ip=YOUR.PUBLIC.IP
realm=example.com

use-auth-secret
static-auth-secret=YOUR_SHARED_TURN_SECRET

cert=/etc/letsencrypt/live/turn.example.com/fullchain.pem
pkey=/etc/letsencrypt/live/turn.example.com/privkey.pem
```

- The **realm** should be your parent domain (`example.com`) — that’s what browsers will see in the auth challenge.
- The **cert** on TURN must match **`turn.example.com`**, not the web app host. If you have a wildcard cert with the app host and turn server on the same machine it'll be fine.

------

## DNS & firewall checklist (quick)

- `turn.example.com` → A/AAAA record to your TURN server **(DNS only / grey cloud if Cloudflare)**
- Open these on the TURN server:
  - UDP **3478**
  - TCP **3478**
  - TCP **5349** (for `turns:`)
  - UDP **49152–65535** (relay ports)
- Open your web app port (e.g. **2087**) and ensure **HTTPS** works.

------

## Quick validation

- Visit Google’s Trickle ICE tester:
   https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
- Paste the **ICE servers** generated by your `/ice` endpoint (it should return entries like):
  - `turn:turn.example.com:3478?transport=udp`
  - `turn:turn.example.com:3478?transport=tcp`
  - `turns:turn.example.com:5349?transport=tcp`
- Click “Gather candidates”. You should see **relay** candidates with your TURN server’s public IP.

------

## Common pitfalls

- **Cloudflare proxy on `turn.example.com`**
  - If proxied (orange cloud), TURN fails (no UDP, TCP is intercepted).
  - Fix: set record to **DNS only**.
- **Mismatched secrets**
  - If `serverinfo.turn.secret` ≠ `static-auth-secret`, allocation fails with `Cannot find credentials of user`.
- **Realm mismatch**
  - If `realm` isn’t `example.com`, some clients refuse auth. Keep realm = your domain.
- **Wrong certs on TURN**
  - Use certs for **`turn.example.com`**; for browsers to accept `turns:` the SNI must match.
- **No relay candidates**
  - Usually blocked UDP ports or missing relay port range. Open 49152–65535/udp and verify `external-ip`.

------

## Minimal values you actually need to fill

- In **app config**:
  - `serverinfo.app.url = "https://app.example.com:2087"`
  - `serverinfo.ssl.* = /etc/letsencrypt/live/app.example.com/...`
  - `serverinfo.turn.host = "turn.example.com"`
  - `serverinfo.turn.port = 3478`
  - `serverinfo.turn.secret = "YOUR_SHARED_TURN_SECRET"`
- In **Coturn**:
  - `realm = example.com`
  - `static-auth-secret = YOUR_SHARED_TURN_SECRET`
  - `cert/pkey = /etc/letsencrypt/live/turn.example.com/...`
  - `external-ip = YOUR.PUBLIC.IP`

that’s the whole mapping your app-config needs — fill those, ensure DNS/firewall are right, and you’re good.